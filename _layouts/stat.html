<html>
    <head>
        <title>{{page.title}}</title>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js" type="text/javascript"> </script>
        <!--[if IE]><script src="media/js/excanvas.compiled.js" type="text/javascript"></script><![endif]-->
        <script src="media/js/jquery.flot.min.js" type="text/javascript"></script>
        <script src="media/js/jquery.flot.crosshair.min.js" type="text/javascript"></script>
        
        <link href="media/css/style.css" rel="stylesheet" />
    </head>
    <body>
        <div id="content">
            <h1>{{page.title}}</h1>
            <div id="placeholder" style="width:600px;height:300px"></div>

            <script>
            {{content}}
            </script>
            
            <script id="source" language="javascript" type="text/javascript">
            $(function () {
                var stripped = {};
                
                for (var key in data[0]) {
                    if (key !== "created")
                        stripped[key] = new Array();
                }

                for (var i=0;i<data.length;i++) {
                    var d = data[i];

                    for (var key in stripped)
                        stripped[key].push([d['created'], d[key]]);
                }

                flot_data = [];
                for (var key in stripped) {
                    var fd = {};
                    fd['data'] = stripped[key];
                    fd['label'] = key+' = 00000000';
                    fd['lines'] = { show: true, fill: true };

                    flot_data.push(fd);
                }

                for (var idx in second_axis)
                    flot_data[second_axis[idx]]['yaxis'] = 2;

                plot = $.plot($("#placeholder"),
                    flot_data,
                    {
                        xaxis: {
                            mode: "time"
                        },
                        crosshair: { mode: "x" },
                        grid: { hoverable: true, autoHighlight: false },

                    }
                );

                var legends = $("#placeholder .legendLabel");
                legends.each(function () {
                    // fix the widths so they don't jump around
                    $(this).css('width', $(this).width());
                });
                var updateLegendTimeout = null;
                var latestPosition = null;

                function updateLegend() {
                    console.log('ciccia');
                    updateLegendTimeout = null;
                    
                    var pos = latestPosition;
                    
                    var axes = plot.getAxes();
                    if (pos.x < axes.xaxis.min || pos.x > axes.xaxis.max ||
                        pos.y < axes.yaxis.min || pos.y > axes.yaxis.max)
                        return;

                    var i, j, dataset = plot.getData();
console.log(dataset);
                    for (i = 0; i < dataset.length; ++i) {
                        var series = dataset[i];

                        // find the nearest points, x-wise
                        for (j = 0; j < series.data.length; ++j)
                            if (series.data[j][0] > pos.x)
                                break;
                        
                        // now interpolate
                        var y, p1 = series.data[j - 1], p2 = series.data[j];
                        if (p1 == null)
                            y = p2[1];
                        else if (p2 == null)
                            y = p1[1];
                        else
                            y = p1[1] + (p2[1] - p1[1]) * (pos.x - p1[0]) / (p2[0] - p1[0]);
                        console.log(series.label.replace(/=.*/, "= " + Math.round(y)));
                        legends.eq(i).text(series.label.replace(/=.*/, "= " + Math.round(y)));
                        console.log(legends);
                    }
                }
                
                $("#placeholder").bind("plothover",  function (event, pos, item) {
                    latestPosition = pos;
                    if (!updateLegendTimeout)
                        updateLegendTimeout = setTimeout(updateLegend, 50);
                });

            });
            </script>
        </div>

    </body>
</html>
